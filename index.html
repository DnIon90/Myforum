// server.js
require('dotenv').config();
const express = require('express');
const cors = require('cors');
const bcrypt = require('bcrypt');
const jwt = require('jsonwebtoken');
const sqlite3 = require('sqlite3').verbose();
const { open } = require('sqlite');
const Stripe = require('stripe');

const stripe = Stripe(process.env.STRIPE_SECRET_KEY); // PLATFORM secret key
const app = express();
app.use(cors());
app.use(express.json());

const JWT_SECRET = process.env.JWT_SECRET || "schimbă_asta";

// --- DB init (sqlite)
let db;
(async () => {
  db = await open({ filename: './data.db', driver: sqlite3.Database });
  await db.exec(`CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    email TEXT UNIQUE,
    password_hash TEXT,
    stripe_account_id TEXT,
    balance INTEGER DEFAULT 0  -- stocăm în "cents" de USD (ex: 150 = $1.50)
  )`);
})();

// --- helper: auth middleware
function authMiddleware(req, res, next) {
  const h = req.headers.authorization;
  if (!h) return res.status(401).json({ error: 'Missing auth' });
  const token = h.split(' ')[1];
  try {
    const payload = jwt.verify(token, JWT_SECRET);
    req.user = payload;
    next();
  } catch (e) {
    return res.status(401).json({ error: 'Invalid token' });
  }
}

// --- register
app.post('/api/register', async (req, res) => {
  const { email, password } = req.body;
  if(!email || !password) return res.status(400).json({ error: 'Email + password required'});
  const hash = await bcrypt.hash(password, 10);
  try {
    const result = await db.run('INSERT INTO users (email, password_hash) VALUES (?,?)', [email, hash]);
    res.json({ ok: true });
  } catch (e) {
    res.status(400).json({ error: 'Email already used' });
  }
});

// --- login
app.post('/api/login', async (req, res) => {
  const { email, password } = req.body;
  const user = await db.get('SELECT * FROM users WHERE email = ?', [email]);
  if(!user) return res.status(400).json({ error: 'Invalid credentials' });
  const ok = await bcrypt.compare(password, user.password_hash);
  if(!ok) return res.status(400).json({ error: 'Invalid credentials' });
  const token = jwt.sign({ id: user.id, email: user.email }, JWT_SECRET, { expiresIn: '7d' });
  res.json({ token });
});

// --- create Stripe Connect account (Express onboarding link)
app.post('/api/connect', authMiddleware, async (req, res) => {
  // Create a connected account and return an account link so user completes onboarding
  const user = await db.get('SELECT * FROM users WHERE id = ?', [req.user.id]);
  if(!user) return res.status(404).json({ error: 'User not found' });

  // If already has a stripe_account_id, create an account link for it
  let accountId = user.stripe_account_id;
  if(!accountId) {
    const account = await stripe.accounts.create({
      type: 'express', // express recommended for platforms
      country: 'US', // adapt la țara ta / user
      capabilities: { transfers: { requested: true } }
    });
    accountId = account.id;
    await db.run('UPDATE users SET stripe_account_id = ? WHERE id = ?', [accountId, user.id]);
  }

  const accountLink = await stripe.accountLinks.create({
    account: accountId,
    refresh_url: process.env.REFRESH_URL || 'https://your-frontend.example/refresh',
    return_url: process.env.RETURN_URL || 'https://your-frontend.example/return',
    type: 'account_onboarding',
  });

  res.json({ url: accountLink.url });
});

// --- endpoint pentru a verifica detalii user / balance
app.get('/api/me', authMiddleware, async (req, res) => {
  const user = await db.get('SELECT id, email, stripe_account_id, balance FROM users WHERE id = ?', [req.user.id]);
  if(!user) return res.status(404).json({ error: 'User not found' });
  res.json({ user });
});

// --- endpoint demo: adaugă bani în cont (doar pentru test) - în producție AI trebuie validare/flux)
app.post('/api/admin/add-funds', async (req, res) => {
  // simplu endpoint demo pentru a adăuga balance (do NOT expune în prod)
  const { email, cents } = req.body; // cents = integer
  await db.run('UPDATE users SET balance = balance + ? WHERE email = ?', [cents, email]);
  res.json({ok:true});
});

/*
  Withdraw flow:
  - Platform must have funds (or create transfer to connected account).
  - For Connect Express/Custom, you can create a Transfer with stripeAccount = connectedAccountId and method='instant'
  - Alternatively create a Payout object; using transfers with method instant via Transfers API (see docs).
  NOTE: availability, limits, eligibility apply. See Stripe docs.
*/
app.post('/api/withdraw', authMiddleware, async (req, res) => {
  try {
    const { amount_cents, currency = 'usd' } = req.body; // e.g. 500 = $5.00
    if(!amount_cents || amount_cents <= 0) return res.status(400).json({ error: 'Invalid amount' });

    const user = await db.get('SELECT * FROM users WHERE id = ?', [req.user.id]);
    if(!user) return res.status(404).json({ error: 'User not found' });
    if(!user.stripe_account_id) return res.status(400).json({ error: 'User has not completed Stripe onboarding' });

    // Check balance
    if(user.balance < amount_cents) return res.status(400).json({ error: 'Insufficient balance' });

    // Create a transfer to the connected account using method=instant
    // Note: transfers are created on platform and moved to connected account
    // You must have available platform balance; this is a simplified example.
    const transfer = await stripe.transfers.create({
      amount: amount_cents,
      currency,
      method: 'instant', // request instant - availability depends on eligibilty
    }, {
      stripeAccount: user.stripe_account_id // perform transfer *to* connected account
    });

    // If successful, decrement user balance in DB
    await db.run('UPDATE users SET balance = balance - ? WHERE id = ?', [amount_cents, user.id]);

    res.json({ ok: true, transfer });
  } catch (err) {
    console.error('withdraw err', err);
    res.status(500).json({ error: err.message || 'withdraw failed' });
  }
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log('Server running on', PORT));